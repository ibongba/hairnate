<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="Description" content="Enter your description here" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />
    <link rel="stylesheet" href="../css/style.css" />


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" />
    <title>Appoinment</title>
</head>
<style>
    input:checked+.slider {
        background-color: #a33e3e;
    }
</style>

<body>
    <div id="nav"></div>

    <div class="container">
        <div class="row my-5">
            <div class="col-md-6">
                <h2>APPOINMENTS</h2>
            </div>

            <div class="col-6 col-md-3">
                <div class="form-group row pt-0 bg-succsee">
                    <div class="col-sm-8">
                        <input id="datepicker" width="190" placeholder="Choose date" /></div>

                </div>
            </div>
            <div class="col">
                <div class="form-group p-0">
                    <select id="inputState" class="form-control" onchange="onchangefilter()">
                  <option value="">FILTER</option>
                  <!-- <option></option> -->
                </select>
                </div>
            </div>

        </div>
        <div class="row">
            <div class="col-md-9">
                <h3 id="date-now"></h3>
                <div class="mt-3 d-none" id="select">
                    <div class="row my-2">
                        <div class="col">
                            <button type="button" class="btn btn-danger time" onclick="allMorning()" id="morning">ช่วงเช้า</button>
                            <button type="button" class="btn btn-secondary time" onclick="onClickBtnMorning(9,'09.00')" id="9" style="background-color: black">09.00</button>
                            <button type="button" class="btn btn-secondary time" onclick="onClickBtnMorning(10,'10.00')" id="10" style="background-color: black">10.00</button>
                            <button type="button" class="btn btn-secondary time" onclick="onClickBtnMorning(11,'11.00')" id="11" style="background-color: black">11.00</button>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col">
                            <button type="button" class="btn btn-danger time" onclick="allEvening()" i id="evening">ช่วงบ่าย</button>
                            <button type="button" class="btn btn-secondary time" onclick="onClickBtnEvening(13,'13.00')" id="13" style="background-color: black">13.00</button>
                            <button type="button" class="btn btn-secondary time" onclick="onClickBtnEvening(14,'14.00')" id="14" style="background-color: black">14.00</button>
                            <button type="button" class="btn btn-secondary time" onclick="onClickBtnEvening(15,'15.00')" id="15" style="background-color: black">15.00</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 p-2">
                <div class="border border-dark p-4 rounded-lg mb-2">
                    <h5 class="float-left">จำนวน</h5>
                    <h5 class="text-right" id="all">10</h5>
                    <h5 class="float-left">สำเร็จ</h5>
                    <h5 class="text-right" id="success">0</h5>
                    <h5 class="float-left">ยกเลิก</h5>
                    <h5 class="text-right" id="cancel">5</h5>
                </div>
                <a href="dashboard.html" class="btn btn-warning float-right">dashboard</a>
            </div>
        </div>
        <hr style="background-color: #eeebe6" />
        <div style="width: 100%;overflow-x: scroll;">
            <table class="table table-striped text-center" id="table">
                <thead>
                    <tr>
                        <th class="app-text">NO.</th>
                        <th class="app-text">SERVICE TIME</th>
                        <th class="app-text">CUSTOMER NAME</th>
                        <th class="app-text">SERVICE TYPE</th>
                        <th class="app-text">BARBER</th>
                        <th class="app-text">ADDRESS</th>
                        <th class="app-text">TEL.</th>
                        <th class="app-text">STATUS</th>
                        <th class="app-text">ALERT</th>
                    </tr>
                </thead>
                <tbody id="detail"></tbody>
            </table>
        </div>
    </div>
    <div class="modal fade" id="service2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <form class="modal-content" onsubmit="createTracking()">
                <div class="modal-header" style="text-align: center;">
                    <h2>ADD TRACKING</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="text-left">
                    <fieldset class="material mb-3">
                        <input type="text" placeholder="" id="number" autocomplete="off" required>
                        <hr>
                        <label>Tracking Number</label>
                    </fieldset>
                    <label for="how">วิธีการจัดส่ง</label>
                    <select class="form-control" id="how" required="">
                          <option value="Kerry" selected="">Kerry</option>
                          <option value="DHL">DHL</option>
                          <option value="ไปรษณีไทย">ไปรษณีไทย</option>
                        </select>
                    <hr>
                    <div class="btn-update" style="text-align: center;">
                        <button type="submit" class="btn btn-danger" style="background-color: #A33E3E;">Create</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <footer>
        <div class="container">
            <div class="foot_logo pt-5">
                <img class="logo-img center-block" src="../images/logo-app-white.png " />
            </div>

            <div class="footer_text">เว็บแอพพลิเคชั่นรวบรวมร้านตัดผมแฟชั่นชาย และตัดผลบริจาคแบบ Delivery ในเขตกรุงเทพมหานครและปริมณฑล</div>

            <div class="foot_icon">
                <a href="# "><i class="fab fa-facebook"></i></a>
                <a href="# "><i class="fab fa-twitter"></i></a>
                <a href="# "><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js "></script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <script src="../js/main.js"></script>
    <script>
        $(function() {
            $('#nav').load('http://localhost/hairnate/layout/navbar.html');
        });
    </script>
    <script>
        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4'
        });
    </script>
    <script>
        var user = JSON.parse(localStorage.getItem('user'));

        function formatDate2(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [year, month, day].join('-');
        }

        const listMonth = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        const formatDate = (date) => {
            console.log(date);
            return date.getDate() + ' ' + listMonth[date.getMonth()].toLocaleUpperCase() + ' ' + (date.getFullYear() + 543);
        };

        var date = '';
        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'yyyy-mm-dd'
        }).on("change", function() {
            console.log(this.value);
            date = formatDate2(this.value);
            $('#select').removeClass('d-none')
            $('#date-now').text(formatDate(new Date(this.value)));

            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_detail_order_by_customer',
                    service_date: date,
                    id_barber: $('#inputState option:selected').val(),
                    id: user.id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    $('#detail').empty();
                    msg.result.map((item) => {
                        $('#detail').append(detail(item));
                        return;
                    });

                    $('#cancel').text(msg.result.filter(item => item.status === 0).length)
                    $('#success').text(msg.result.filter(item => item.status === 3).length)
                    $('#all').text(msg.result.length)
                }
            });

            $('.time').removeClass('disabled');

            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_closed',
                    date: date,
                    user_id: user.id,
                }
            }).done((msg) => {
                msg = JSON.parse(msg)
                console.log(msg);
                if (msg.code === 200) {
                    msg.result.map((item) => {
                        $('#' + parseInt(item.time)).addClass('disabled');
                    })

                    if ($('#9').hasClass('disabled') && $('#10').hasClass('disabled') && $('#11').hasClass('disabled')) {
                        $('#morning').addClass('disabled');
                    }
                    if ($('#13').hasClass('disabled') && $('#14').hasClass('disabled') && $('#15').hasClass('disabled')) {
                        $('#evening').addClass('disabled');
                    }
                }
            })
        });

        detail = (item) => {
                var img = item.image ? item.image : 'https://via.placeholder.com/150';
                const date = new Date(item.service_date);
                const result = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                });
                if (item.status == '0') {
                    item.status = "cancel"
                } else if (item.status == '2') {
                    item.status = "Paid"
                } else {
                    item.status = "Finish"
                }
                return `
			             <tr class="app-text">
                            <th scope="row">${item.id_service_detail}</th>
                            <td>${item.service_time}</td>
                            <td>${item.customer_name}</td>
                            <td>${item.service_type}</td>
                            <td>${item.barber_name}</td>
                            <td>${item.address}</td>
                            <td>${item.phone}</td>
                            <td class="text-success">${item.status}</td>
                            ${
                                item.status == "Paid" ? `<td><button type="button" class="btn btn-danger" onclick="sendMail('${item.email}')" style="min-width: auto;">Alert</button></td>` : ''
                            }
                            ${
                                !item.tracking_on && item.status == "Finish" && user.biz_type == "2" ? `<td><button type="button" data-toggle="modal" data-target="#service2" data-whatever="@getbootstrap" onclick="setId('${item.id_service_detail}')" class="btn btn-danger" style="min-width: auto;">Add Tracking</button></td>` : `<td></td>`
                            }
                        </tr>
                        ${
                            item.tracking_on ? `<tr class="app-text">
                                <td colspan="4">จัดส่งโดย ${item.tracking_type}</td>
                                <td colspan="5">tracking number ${item.tracking_on}</td>
                            </tr>` : ``
                        }

			             `;
        };

        var _id = '';

        const setId = (id) => {
            _id = id;
        }

        const createTracking =()=> {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'create_traking',
                    tracking_on: $('#number').val(),
                    tracking_type: $('#how option:selected').val(),
                    fk_sd_id: _id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                    // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    window.location.reload();
                }
            });
        }


        const onchangefilter = () => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_detail_order_by_customer',
                    service_date: date,
                    id_barber: $('#inputState option:selected').val(),
                    id: user.id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                console.log(msg)
                    // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    $('#detail').empty();
                    msg.result.map((item) => {
                        $('#detail').append(detail(item));
                        return;
                    });

                    $('#cancel').text(msg.result.filter(item => item.status === 0).length)
                    $('#success').text(msg.result.filter(item => item.status === 3).length)
                    $('#all').text(msg.result.length)
                }
            });
        }

        const sendMail = (mail) => {
            $.ajax({
                method: 'POST',
                url: '../service/mail.php',
                data: {
                    mail:mail,
                }
            }).done(function(msg) {
                alert(msg)
            });
        }

        $().ready(() => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_filter',
                    id: user.id,
                },
                dataType: 'json',
            }).done(function(msg) {
                if (msg.code === 200) {
                    $('#filter').empty();
                    msg.result.map((item) => {
                        $('#inputState').append(inputState(item));
                        return;
                    });
                }
            });
        });

        inputState = (item) => {
            return `
            <option value="${item.id_barber}">${item.name}</option>
			             `;
        };

        remove = (time) => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'remove_closed',
                    date: date,
                    time: time,
                    user_id: user.id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            })
        }

        add = (time) => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'add_closed',
                    date: date,
                    time: time,
                    user_id: user.id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            })
        }

        onClickBtnMorning = (id,time) => {
            if($('#'+id).hasClass('disabled')){
                $('#morning').removeClass('disabled');
                $('#'+id).removeClass('disabled');

                remove(time)
            }else{
                $('#'+id).addClass('disabled');

                add(time)

                if($('#9').hasClass('disabled') && $('#10').hasClass('disabled') && $('#11').hasClass('disabled')){
                    $('#morning').addClass('disabled');
                }
            }
        }

        onClickBtnEvening = (id,time) => {
            if($('#'+id).hasClass('disabled')){
                $('#evening').removeClass('disabled');
                $('#'+id).removeClass('disabled');

                remove(time)
            }else{
                $('#'+id).addClass('disabled');

                add(time)

                if($('#13').hasClass('disabled') && $('#14').hasClass('disabled') && $('#15').hasClass('disabled')){
                    $('#evening').addClass('disabled');
                }
            }
        }

        allMorning = () => {

            if($('#morning').hasClass('disabled')){

                $('#morning').removeClass('disabled');
                $('#9').removeClass('disabled');
                $('#10').removeClass('disabled');
                $('#11').removeClass('disabled');

                remove('09.00')
                remove('10.00')
                remove('11.00')
            }else{
                $('#morning').addClass('disabled');
                $('#9').addClass('disabled');
                $('#10').addClass('disabled');
                $('#11').addClass('disabled');

                add('09.00')
                add('10.00')
                add('11.00')

            }
        }

        allEvening = () => {

            if($('#evening').hasClass('disabled')){

                $('#evening').removeClass('disabled');
                $('#13').removeClass('disabled');
                $('#14').removeClass('disabled');
                $('#15').removeClass('disabled');

                remove('13.00')
                remove('14.00')
                remove('15.00')
            }else{
                $('#evening').addClass('disabled');
                $('#13').addClass('disabled');
                $('#14').addClass('disabled');
                $('#15').addClass('disabled');

                add('13.00')
                add('14.00')
                add('15.00')

            }
        }
    </script>
</body>

</html>