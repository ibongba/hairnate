<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="Description" content="Enter your description here" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <title>USER</title>
</head>

<body>
    <div id="nav"></div>
    <div class="container">
        <div class="row my-5">
            <div class="col-md-3 col-sm-12 mt-3">
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item w-100">
                        <a class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab">MY ORDER</a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link" data-toggle="tab" href="#tabs-2" role="tab">PROFILE</a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link" data-toggle="tab" href="#tabs-3" role="tab">MY ADDRESS</a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link" data-toggle="tab" href="#tabs-4" role="tab">MY PAYMENT METHODS</a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link" data-toggle="tab" href="#tabs-5" role="tab">HELP CENTER</a>
                    </li>
                    <li class="nav-item w-100">
                        <a class="nav-link" data-toggle="tab" href="#tabs-6" role="tab">MORE</a>
                    </li>
                </ul>
            </div>

            <div class="col-md-9 col-sm-12">
                <!-- Tab panes -->
                <div class="tab-content mt-3">
                    <div class="tab-pane active" id="tabs-1" role="tabpanel">
                        <div id="accordionExample">
                            <!-- <div id="user"></div> -->
                            <h3>PRESENT ORDERS</h3>
                            <div class="accordion status2">
                            </div>
                            <h3>PAST ORDERS</h3>
                            <div class="accordion status-other">

                                <!-- Modal review -->
                                <div class="modal fade" id="review_barber" tabindex="-1" aria-labelledby="review_barberLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-body"> <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span> </button>
                                                <h5 class="text-center pt-3">REVIEW</h5>
                                                <form class="m-0 p-0">
                                                    <div class="rate" style="flex-direction: row; justify-content: center;">
                                                        <input type="radio" id="star5" name="rate" value="5" />
                                                        <label for="star5" title="text">5 stars</label>
                                                        <input type="radio" id="star4" name="rate" value="4" />
                                                        <label for="star4" title="text">4 stars</label>
                                                        <input type="radio" id="star3" name="rate" value="3" />
                                                        <label for="star3" title="text">3 stars</label>
                                                        <input type="radio" id="star2" name="rate" value="2" />
                                                        <label for="star2" title="text">2 stars</label>
                                                        <input type="radio" id="star1" name="rate" value="1" />
                                                        <label for="star1" title="text">1 star</label>
                                                    </div>
                                                    <div class="form-group">
                                                        <textarea class="form-control" id="textarea" rows="3"></textarea>
                                                    </div>
                                                </form>
                                                <button onclick="create_review()" type="button" class="btn btn-dark mt-3" style="width: 120px;font-size: medium;
                                                padding: 9px;
                                                border-radius: 25px;">DONE</button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-2" role="tabpanel">
                        <table class="table table-borderless">
                            <thead>
                                <tr>
                                    <th>CONTACT INFORMATION</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>First name</td>
                                    <td class="text-right">Taylor</td>
                                </tr>
                                <tr>
                                    <td>Last name</td>
                                    <td class="text-right">Swift</td>
                                </tr>
                                <tr>
                                    <td>Email Address</td>
                                    <td class="text-right">Taylor.Swift@gmail.com</td>
                                </tr>
                                <tr>
                                    <td>Mobile Number</td>
                                    <td class="text-right">+66123456789</td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="table table-borderless">
                            <thead>
                                <tr>
                                    <th>SETTINGS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Language</td>
                                    <td class="text-right" style="color: #a33e3e">English</td>
                                </tr>
                                <tr>
                                    <td>Change Password</td>
                                    <td class="text-right">******</td>
                                </tr>
                                <tr>
                                    <td>Receive offers by email</td>
                                    <td class="text-right"><label class="switch">
                                        <input type="checkbox" checked />
                                        <span class="slider round"></span>
                                    </label></td>
                                </tr>
                                <tr>
                                    <td>Mobile Number</td>
                                    <td class="text-right">+66123456789</td>
                                </tr>
                            </tbody>
                        </table>

                        <button type="button" class="btn btn-dark" style="width: 150px">SAVE</button>
                    </div>
                    <div class="tab-pane" id="tabs-3" role="tabpanel">
                        <h3>MY ADDERSS</h3>

                        <p><i class="fas fa-map-marker-alt" style="font-size: xx-large; color: #a33e3e"></i><b> HOME</b></p>
                        <i class="fas fa-pen float-right" type="button" style="font-size: large; color: #a33e3e"></i>
                        <p>365 Bond St. Chang Wat Nonthaburi 11120</p>
                        <p class="mb-5">Note to Barber : เอ็มโซไซตี้คอนโด เมืองทองธานี</p>
                        <button type="button" class="btn btn-dark">ADD NEW ADDRESS</button>
                    </div>
                    <div class="tab-pane" id="tabs-4" role="tabpanel">
                        <h3>PAYMENT METHODS</h3>
                        <table class="table mt-4" style="background-color: #faf9f7">
                            <tbody>
                                <tr>
                                    <td>
                                        COACH CRAFTSMAN<br />
                                        <p class="m-0" style="font-size: small">Package A : Under Cut + ไถข้าง</p>
                                        <p class="text-black-50" style="font-size: small">12 February 2020, 10.30 AM</p>
                                    </td>
                                    <td class="text-right">
                                        <p class="text-success" style="font-size: small">Paid Successful</p>
                                        <h6><b>฿ 1,500</b></h6>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        COACH CRAFTSMAN<br />
                                        <p class="m-0" style="font-size: small">Package A : Under Cut + ไถข้าง</p>
                                        <p class="text-black-50" style="font-size: small">12 February 2020, 10.30 AM</p>
                                    </td>
                                    <td class="text-right">
                                        <p class="text-success" style="font-size: small">Paid Successful</p>
                                        <h6><b>฿ 1,500</b></h6>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        COACH CRAFTSMAN<br />
                                        <p class="m-0" style="font-size: small">Package A : Under Cut + ไถข้าง</p>
                                        <p class="text-black-50" style="font-size: small">12 February 2020, 10.30 AM</p>
                                    </td>
                                    <td class="text-right">
                                        <p class="text-success" style="font-size: small">Paid Successful</p>
                                        <h6><b>฿ 1,500</b></h6>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane" id="tabs-5" role="tabpanel">
                        <h3><b>HELP CENTER</b></h3>
                    </div>
                    <div class="tab-pane" id="tabs-6" role="tabpanel">
                        <h3><b>MORE</b></h3>
                        <hr />
                        <i class="fas fa-folder float-left" style="font-size: large; color: #a33e3e"></i>
                        <p>&nbsp;<b>SAVED</b></p>
                        <img src="images/m1.png" alt="" class="col-md-3 col-sm-12 p-2 float-left" />
                        <img src="images/m2.png" alt="" class="col-md-3 col-sm-12 p-2 float-left" />
                        <img src="images/m3.png" alt="" class="col-md-3 col-sm-12 p-2 float-left" />
                        <img src="images/m4.png" alt="" class="col-md-3 col-sm-12 p-2 float-left" />
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="review_id">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let images = [];
        $(function() {
            $('#nav').load('layout/navbar.html');

            $.ajax({
                method: 'POST',
                url: 'service/core.php',
                data: {
                    action: 'get_order_by_customer',
                    id: JSON.parse(localStorage.getItem('user'))['id'],
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                let data = msg.result.sd;
                images = [...msg.result.images]

                data.filter((item) => {



                    var dateFirst = new Date(item.service_date);
                    var dateSecond = new Date();

                    // time difference
                    var timeDiff = dateSecond.getTime() - dateFirst.getTime();

                    // days difference
                    var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    return item.status === '2' && diffDays <= 0
                }).map((item, i) => {
                    $('.status2').append(card(item, i));
                });

                if (data.filter((item) => item.status === '2').lenght === 0) {
                    $('.status2').append('ไม่พบรายการ');
                }

                data.filter((item) => {


                    var dateFirst = new Date(item.service_date);
                    var dateSecond = new Date();

                    // time difference
                    var timeDiff = dateSecond.getTime() - dateFirst.getTime();

                    // days difference
                    var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));


                    return item.status !== '2' || diffDays > 0

                }).map((item) => {
                    $('.status-other').append(cardOther(item));
                });


            });
        });

        const listMonth = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        const formatDate = (date) => {
            console.log(date);
            return date.getDate() + ' ' + listMonth[date.getMonth()].toLocaleUpperCase() + ' ' + (date.getFullYear() + 543);
        };

        const card = (item, i) => {
            return `
						<div class="card">
			             <div class="card-header" id="heading${item.id_service_detail}">
			                 <h2 class="mb-0">
			                     <button class="btn btn-link btn-block text-left text-decoration-none collapsed ${i===0 ? 'show' : ''} " type="button" data-toggle="collapse" data-target="#collapse${
										item.id_service_detail
									}" aria-expanded="false" aria-controls="collapse${item.id_service_detail}">
			                         <div class="row">
			                             <div class="col-md-6 pl-0">
			                                 <h6 class="m-0"><b>${item.biz_name}</b></h6>
			                                 <p class="m-0" style="font-size: small;"><b>${item.name}</b></p>
			                                 <p class="text-black-50" style="font-size: small;">${formatDate(new Date(item.service_date))}, ${item.service_time}</p>
			                             </div>
			                             <div class="col-md-6 text-right">
                                            <h6 class="text-black-50"> Waiting for Service</h6>
                                            <h6 class="text-right"><b>฿ ${item.promotion_price || item.price}</b></h6>
                                        </div>
			                         </div>
			                     </button>
			                 </h2>
			             </div>
			             <div id="collapse${item.id_service_detail}" class="collapse" aria-labelledby="heading${item.id_service_detail}" data-parent="#accordionExample">
			                 <div class="card-body">
			                     <div class="row">
			                         <div class="col pt-2" style="font-size: small;">
			                             <p class="m-0">${item.name}</p>
			                             <p class="m-0">Barber : ช่าง ${item.barber_name}</p>
			                             <p class="m-0">Address : ${item.service_location}</p>
			                             <p class="m-0">Finished : ${(parseFloat(item.service_time) + 1).toFixed(2)}</p>
			                         </div>
			                         <div class="col h-100" style="flex-direction: column;">
			                             <a href="usercancle.html?id=${
												item.id_service_detail
											}" class="btn btn-danger d-flex float-right h-100" style="justify-content: flex-end; align-items: flex-end; background-color: #A33E3E;">ยกเลิกบริการ</a>
			                         </div>
			                     </div>
			                 </div>
			                 </div>
			             </div>`;
        };


        const cardOther = (item) => {
                let currentImg = images.filter((i) => i.fk_sd_id === item.id_service_detail).map((i) => `<div class="w-50 px-2 float-right"><img src="${i.path}" alt="" class="img-thumbnail" /></div>`)
                var dateFirst = new Date(item.service_date);
                var dateSecond = new Date();

                // time difference
                var timeDiff = Math.abs(dateSecond.getTime() - dateFirst.getTime());

                // days difference
                var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
                return `
                <div class="card">
                    <div class="card-header" id="heading${item.id_service_detail}">
                        <h2 class="mb-0">
                            <button
                                class="btn btn-link btn-block text-left"
                                type="button"
                                data-toggle="collapse"
                                data-target="#collapse${item.id_service_detail}"
                                aria-expanded="true"
                                aria-controls="collapse${item.id_service_detail}"
                            >
                                <div class="row">
                                    <div class="col float-left pl-0">
                                        <h6 class="m-0"><b>${item.biz_name}</b></h6>
                                        <p class="m-0" style="font-size: small;"><b>${item.name}</b></p>
                                        <p class="text-black-50" style="font-size: x-small;">${formatDate(new Date(item.service_date))}, ${item.service_time}</p>
                                    </div>
                                    <div class="col text-right">
                                        <div class="float-right">
                                            ${(item.status == 0)? '<h6 class="text-danger text-right" >Cancel</h6>' : '' }
                                            ${(item.status == 2) ? `<a class="btn btn-light float-left mx-2" data-toggle="modal" data-target="#review_barber" style="border-radius: 15px; font-size: x-small;" onclick="setid('${item.id_service_detail}')" >REVIEW</a>` : ''}
                                            ${(item.status == 3)? '<h6 class="text-success text-right" >Successfully</h6>' : '' }


                                          </div><br><br>
                                        <h6 class="text-right"><b>฿ ${item.promotion_price || item.price}</b></h6>
                                    </div>
                                </div>
                            </button>
                        </h2>
                    </div>

                    <div id="collapse${item.id_service_detail}" class="collapse" aria-labelledby="heading${item.id_service_detail}" data-parent="#accordionExample">
                        <div class="card-body">
                            <div class="row">
                                <div class="col pt-2" style="font-size: small">
                                    <p class="m-0">${item.name}</p>
                                    <p class="m-0">Barber : ช่าง ${item.barber_name}</p>
                                    <p class="m-0">Address : ${item.service_location}</p>
                                    <p class="m-0">Finished : ${(parseFloat(item.service_time) + 1).toFixed(2)}</p>
                                    ${item.tracking_on ? `
                                        <p class="m-0">จัดส่งโดย : ${item.tracking_type}</p>
                                        <p class="m-0">หมายเลขจัดส่ง : ${item.tracking_on}</p>

                                        ` : ''}
                                </div>
                                <div class="col">
                                    ${currentImg.toString().replace(',','')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `
        }

        const create_review = () => {
            $.ajax({
                method: "POST",
                url: "service/core.php",
                data: {
                    action: 'create_review',
                    id: $('#review_id').val(),
                    rate : $(`input[name=rate]`).val(),
                    detail : $('textarea#textarea').val(),
                    status : 3
                }
            }).done(function(msg) {
                msg = JSON.parse(msg)
                console.log(msg)
                if (msg.code === 200) {
                    window.location.reload();
                }
            });
        }

        const setid = (id) => {
            $('#review_id').val(id)
        }
    </script>
</body>

</html>