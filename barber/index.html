<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="Description" content="Enter your description here" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />
    <link rel="stylesheet" href="../css/style.css" />


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" />
    <title>Appoinment</title>
</head>
<style>
    input:checked+.slider {
        background-color: #a33e3e;
    }
</style>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
                <a href="/hairnate/index.html">
                    <img class="logo-img center-block" src="/hairnate/images/logo-app-white.png" />
                </a>
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item active">
                        <a href="/hairnate/index.html">HOME <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item is-partner">
                        <a href="/hairnate/partner/appoinment.html">APPOINMENT</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a href="#"><i class="fas fa-search"></i></a>
                    </li>
                    <li class="nav-item not-login">
                        <a href="/hairnate/login.html"><i class="fas fa-user"></i></a>
                    </li>
                    <li class="nav-item is-login text-light">
                        <a onclick="logout()"><i class="fas fa-sign-out-alt "></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-between my-5">
            <div class="col-md-6" id="app_name">

            </div>
            <div class="col-md-4">
                <div class="form-group row pt-0 bg-succsee">
                    <div class="col-sm-8">
                        <input id="datepicker" width="200" placeholder="Choose date" /></div>

                </div>
            </div>

        </div>
        <hr class="col-12" style="background-color: #eeebe6" />
        <div class="d-lg-none">
            <ul id="columns-dropdown" style=" list-style: none;">
                <li><input type="checkbox" class="col-checkbox" id="label_no" data-col="app_no"><label for="label_no">&nbsp; NO.</label></li>
                <li><input type="checkbox" class="col-checkbox" id="label_st" data-col="app_st"><label for="label_st">&nbsp; SERVICE TIME</label></li>
                <li><input type="checkbox" class="col-checkbox" id="label_cn" data-col="app_cn"><label for="label_cn">&nbsp; CUSTOMER NAME</label></li>
                <li><input type="checkbox" class="col-checkbox" id="label_sty" data-col="app_sty"><label for="label_sty">&nbsp; SERVICE TYPE</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_barber" data-col="app_barber"><label for="label_barber">&nbsp; BARBER</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_address" data-col="app_address"><label for="label_address">&nbsp; ADDRESS</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_tel" data-col="app_tel"><label for="label_tel">&nbsp; TEL.</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_status" data-col="app_status"><label for="label_status">&nbsp; STATUS</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_status" data-col="app_map"><label for="label_map">&nbsp; MAP</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_alert" data-col="app_alert"><label for="label_alert">&nbsp; ALERT</label> </li>
                <li><input type="checkbox" class="col-checkbox" id="label_pic" data-col="app_pic"><label for="label_pic">&nbsp; PICTURE</label> </li>
            </ul>
        </div>
        <div style="width: 100%;overflow-x: hidden;">
            <table class="table table-striped text-center" id="table">
                <thead>
                    <tr>
                        <th class="app-text app_no">NO.</th>
                        <th class="app-text app_st">SERVICE TIME</th>
                        <th class="app-text app_cn">CUSTOMER NAME</th>
                        <th class="app-text app_sty">SERVICE TYPE</th>
                        <th class="app-text app_barber">BARBER</th>
                        <th class="app-text app_address">ADDRESS</th>
                        <th class="app-text app_tel">TEL.</th>
                        <th class="app-text app_status">STATUS</th>
                        <th class="app-text app_map">MAP</th>
                        <th class="app-text app_alert">ALERT</th>
                        <th class="app-text app_pic">PICTURE</th>
                    </tr>
                </thead>
                <tbody id="detail"></tbody>
            </table>
        </div>
    </div>
    <div class="modal fade" id="service2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <form class="modal-content" onsubmit="createTracking()">
                <div class="modal-header" style="text-align: center;">
                    <h2>ADD TRACKING</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="text-left">
                    <fieldset class="material mb-3">
                        <input type="text" placeholder="" id="number" autocomplete="off" required>
                        <hr>
                        <label>Tracking Number</label>
                    </fieldset>
                    <label for="how">วิธีการจัดส่ง</label>
                    <select class="form-control" id="how" required="">
                          <option value="Kerry" selected="">Kerry</option>
                          <option value="DHL">DHL</option>
                          <option value="ไปรษณีไทย">ไปรษณีไทย</option>
                        </select>
                    <hr>
                    <div class="btn-update" style="text-align: center;">
                        <button type="submit" class="btn btn-danger" style="background-color: #A33E3E;">Create</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="picture" tabindex="-1" aria-labelledby="pictureLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pictureLabel">PICTURE</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
                </div>
                <div class="modal-body">
                    <div id="show_picture"></div>
                    <!-- <img src="../images/payment.png" alt="" class="w-100"> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            <div class="foot_logo pt-5">
                <img class="logo-img center-block" src="../images/logo-app-white.png " />
            </div>

            <div class="footer_text">เว็บแอพพลิเคชั่นรวบรวมร้านตัดผมแฟชั่นชาย และตัดผลบริจาคแบบ Delivery ในเขตกรุงเทพมหานครและปริมณฑล</div>

            <div class="foot_icon">
                <a href="# "><i class="fab fa-facebook"></i></a>
                <a href="# "><i class="fab fa-twitter"></i></a>
                <a href="# "><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js "></script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <script src="../js/main.js"></script>
    <script>
        const logout = () => {
            localStorage.clear();
            $('.is-login').addClass('d-none');
            $('.not-login').removeClass('d-none');


            window.location.href = "../barber/login.html";
        }
        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4'
        });
    </script>
    <script>
        var user = JSON.parse(localStorage.getItem('user'));

        const colCheckboxes = document.querySelectorAll(".col-checkbox");

        colCheckboxes.forEach((element) => {
            // Set checked by Default
            element.checked = true;
            element.addEventListener("change", (event) => {
                const checked = event.target.checked;
                const colName = element.getAttribute("data-col");

                hideShowTableCol(colName, checked);
            });
        });

        function hideShowTableCol(colName, checked) {
            const cells = document.querySelectorAll(`.${colName}`);
            cells.forEach((cell) => {
                cell.style.display = checked ? "table-cell" : "none";
            });
        }

        $(function() {
            if (user) {
                $('.is-login').removeClass('d-none');
                $('.not-login').addClass('d-none');
            }
        });
        $().ready(() => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_appointment_name_barber',
                    barber_id: user.id_barber,
                },
                dataType: 'json',
            }).done(function(msg) {
                // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    $('#app_name').append(app_name(msg.result));
                }
            });
        });

        app_name = (item) => {
            return `
            <h2>APPOINTMENT</h2>
            <h3>Barber Name : ${item.name}</h3>
			             `;
        }

        function formatDate2(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [year, month, day].join('-');
        }

        const listMonth = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        const formatDate = (date) => {
            console.log(date);
            return date.getDate() + ' ' + listMonth[date.getMonth()].toLocaleUpperCase() + ' ' + (date.getFullYear() + 543);
        };

        var date = '';
        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'yyyy-mm-dd'
        }).on("change", function() {
            console.log(this.value);
            date = formatDate2(this.value);
            $('#select').removeClass('d-none')
            $('#date-now').text(formatDate(new Date(this.value)));

            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_detail_order_by_barber',
                    service_date: date,
                    id_barber: user.id_barber,
                    id_partner: user.id_partner,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    $('#detail').empty();
                    msg.result.map((item) => {
                        $('#detail').append(detail(item));
                        return;
                    });

                    $('#cancel').text(msg.result.filter(item => item.status === 0).length)
                    $('#success').text(msg.result.filter(item => item.status === 3).length)
                    $('#all').text(msg.result.length)
                }
            });

            $('.time').removeClass('disabled');
        });



        detail = (item) => {
                var img = item.image ? item.image : 'https://via.placeholder.com/150';
                const date = new Date(item.service_date);
                const result = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                });
                if (item.status == '0') {
                    item.status = "cancel"
                } else if (item.status == '2') {
                    item.status = "Paid"
                } else {
                    item.status = "Finish"
                }
                return `
			             <tr class="app-text">
                            <th class="app_no" scope="row">${item.id_service_detail}</th>
                            <td class="app_st">${item.service_time}</td>
                            <td class="app_cn">${item.customer_name}</td>
                            <td class="app_sty">${item.service_type}</td>
                            <td class="app_barber">${item.barber_name}</td>
                            <td class="app_address">${item.address}</td>
                            <td class="app_tel">${item.phone}</td>
                            <td class="text-success app_status">${item.status}</td>
                            <td class="text-success app_map"><a href="https://www.google.com/maps/place/${item.lat},${item.lon}">map</a></td>
                            ${
                                item.status == "Paid" ? `<td class="app_alert"><button type="button" class="btn btn-danger" onclick="sendMail('${item.email}','${item.service_date}')" style="min-width: auto;">Alert</button></td>` : ''
                            } 
                            <td class="app_alert"><button type="button" class="btn btn-info" data-toggle="modal" data-target="#picture" onclick="id_picture('${item.id_service_detail}')">Picture</button></td>
                            <td class="app_pic"><a href="updateSevice.php?id=${item.id_service_detail}" class="btn btn-warning">update</a
                                ></td>
                            ${
                                !item.tracking_on && item.status == "Finish" && user.biz_type == "2" ? `<td><button type="button" data-toggle="modal" data-target="#service2" data-whatever="@getbootstrap" onclick="setId('${item.id_service_detail}')" class="btn btn-danger" style="min-width: auto;">Add Tracking</button></td>` : `<td></td>`
                            }
                           
                        </tr>
                        ${
                            item.tracking_on ? `<tr class="app-text">
                                <td colspan="4">จัดส่งโดย ${item.tracking_type}</td>
                                <td colspan="5">tracking number ${item.tracking_on}</td>
                            </tr>` : ``
                        }

			             `;
        };

        var _id = '';

        const setId = (id) => {
            _id = id;
        }
        const id_picture = (id) => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_picture',
                    fk_sd_id: id,
                },
                dataType: 'json',
            }).done(function(msg) {
                // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    $('#show_picture').empty();
                    for (i = 0; i < msg.result.length; i++) {
                        $('#show_picture').append(picture(msg.result[i]));
                    };                   
                }
            });
        }
         
        picture = (item) => {
            var img = item.path ? '../' + item.path : 'https://via.placeholder.com/150';
            return `
                   
                        <img class="w-100" src="${img}" />
              
                    `;
        }
        const createTracking =()=> {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'create_traking',
                    tracking_on: $('#number').val(),
                    tracking_type: $('#how option:selected').val(),
                    fk_sd_id: _id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                    // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    window.location.reload();
                }
            });
        }

        const onchangefilter = () => {
            $.ajax({
                method: 'POST',
                url: '../service/core.php',
                data: {
                    action: 'get_detail_order_by_customer',
                    service_date: date,
                    id_barber: $('#inputState option:selected').val(),
                    id: user.id,
                },
                dataType: 'json',
                // contentType: false,
                // processData: false,
            }).done(function(msg) {
                console.log(msg)
                    // msg = JSON.parse(msg);
                console.log(msg)
                if (msg.code === 200) {
                    $('#detail').empty();
                    msg.result.map((item) => {
                        $('#detail').append(detail(item));
                        return;
                    });

                    $('#cancel').text(msg.result.filter(item => item.status === 0).length)
                    $('#success').text(msg.result.filter(item => item.status === 3).length)
                    $('#all').text(msg.result.length)
                }
            });
        }

        const sendMail = (mail) => {
            var date1 = new Date();
            var date2 = new Date(date);
            var diffDays = date2.getDate() - date1.getDate(); 
            // alert(diffDays)
            $.ajax({
                method: 'POST',
                url: '../service/mail.php',
                data: {
                    mail:mail,
                    num_date: diffDays,
                }
            }).done(function(msg) {
                alert(msg)
            });
        }
        inputState = (item) => {
            return `
            <option value="${item.id_barber}">${item.name}</option>
			             `;
        };
    </script>
</body>

</html>